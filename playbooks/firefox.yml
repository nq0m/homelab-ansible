- name: Remove ESR and install upstream Firefox
  hosts: local
  become: true
  tasks:
    - name: Remove firefox-esr if present
      ansible.builtin.apt:
        name: firefox-esr
        state: absent
        purge: true
        update_cache: true
        cache_valid_time: 3600
      tags: ['pkg', 'firefox']

    - name: Ensure wget is installed
      ansible.builtin.apt:
        name: wget
        state: present
        update_cache: true
        cache_valid_time: 3600
      tags: ['pkg', 'wget']

    - name: Create keyrings directory for Mozilla repo
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Download Mozilla APT repo signing key
      ansible.builtin.get_url:
        url: https://packages.mozilla.org/apt/repo-signing-key.gpg
        dest: /etc/apt/keyrings/packages.mozilla.org.asc
        mode: '0644'
        checksum: "{{ mozilla_key_checksum | default(omit) }}"
      tags: ['pkg', 'firefox']

    - name: Add Mozilla deb822-style repository (Debian 13+)
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/mozilla.sources
        content: |
          Types: deb
          URIs: https://packages.mozilla.org/apt
          Suites: mozilla
          Components: main
          Signed-By: /etc/apt/keyrings/packages.mozilla.org.asc
        mode: '0644'

    - name: Pin Mozilla repo with high priority
      ansible.builtin.copy:
        dest: /etc/apt/preferences.d/mozilla
        content: |
          Package: *
          Pin: origin packages.mozilla.org
          Pin-Priority: 1000
        mode: '0644'

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true

    - name: Install upstream Firefox
      ansible.builtin.apt:
        name: firefox
        state: present
